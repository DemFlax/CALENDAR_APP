rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper: verificar rol
    function isManager() {
      return request.auth != null && request.auth.token.role == 'manager';
    }
    
    function isGuide() {
      return request.auth != null && request.auth.token.role == 'guide';
    }
    
    function getGuideId() {
      return request.auth.token.guideId;
    }
    
    // Colección guides
    match /guides/{guideId} {
      // Manager: lectura/escritura total
      allow read, write: if isManager();
      
      // Guía: solo lectura de su propio documento
      allow read: if isGuide() && getGuideId() == guideId;
    }
    
    // Colección shifts
    match /shifts/{shiftId} {
      // Manager: lectura/escritura total
      allow read, write: if isManager();
      
      // Guía: puede leer todos los turnos (para ver calendario)
      allow read: if isGuide();
      
      // Guía: puede bloquear turnos LIBRES (LIBRE → NO_DISPONIBLE)
      allow update: if isGuide() 
                    && resource.data.estado == 'LIBRE'
                    && request.resource.data.estado == 'NO_DISPONIBLE'
                    && request.resource.data.guiaId == getGuideId();
      
      // Guía: puede desbloquear SUS turnos bloqueados (NO_DISPONIBLE → LIBRE)
      allow update: if isGuide()
                    && resource.data.estado == 'NO_DISPONIBLE'
                    && resource.data.guiaId == getGuideId()
                    && request.resource.data.estado == 'LIBRE'
                    && request.resource.data.guiaId == null;
    }
    
    // Colección notifications (solo lectura manager)
    match /notifications/{notificationId} {
      allow read, write: if isManager();
    }
  }
}