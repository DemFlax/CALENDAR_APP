# Historias de Usuario - Tour Details Page
**Proyecto:** Spain Food Sherpas - Calendar App  
**Fecha:** 14 Octubre 2025  
**Versi√≥n:** 1.0  

---

## USER STORY #1: Navegaci√≥n a detalles de tour

**ID:** US-TD-001  
**Como:** Gu√≠a  
**Quiero:** Clicar una asignaci√≥n en mi dashboard  
**Para:** Ver detalles del tour y guests para hacer checkin  

**Prioridad:** Alta  
**Estimaci√≥n:** 3 puntos  

### Criterios de Aceptaci√≥n

```gherkin
Feature: Navegaci√≥n a detalles de tour desde dashboard

Scenario: Clic en asignaci√≥n existente
  Given estoy autenticado como gu√≠a
  And estoy en la secci√≥n "Mis Pr√≥ximas Asignaciones"
  And veo una asignaci√≥n con eventId "abc123"
  When hago clic en la card de asignaci√≥n
  Then navego a "/tour-details.html?eventId=abc123&title=Madrid%20Tapas&date=2025-10-30&time=17:30"
  And los par√°metros se codifican correctamente en URL

Scenario: URL con par√°metros faltantes
  Given navego directamente a "/tour-details.html?eventId=abc123"
  And faltan par√°metros title, date o time
  When la p√°gina carga
  Then muestro header con skeleton loader
  And espero respuesta de API para completar datos

Scenario: Navegaci√≥n en PWA instalada
  Given tengo la app instalada en iOS/Android
  When hago clic en asignaci√≥n
  Then navego sin abrir navegador externo
  And mantengo contexto de sesi√≥n
```

### Notas T√©cnicas
- `guide-dashboard.js`: A√±adir event listener a cards de asignaciones
- URL encoding para caracteres especiales en title
- Validar que eventId existe antes de navegar

### Definici√≥n de Hecho
- [ ] Cards de asignaciones clicables con cursor pointer
- [ ] URL se construye con todos los par√°metros
- [ ] Navegaci√≥n funciona en desktop y mobile
- [ ] PWA mantiene contexto de sesi√≥n

---

## USER STORY #2: Visualizaci√≥n de detalles de tour

**ID:** US-TD-002  
**Como:** Gu√≠a  
**Quiero:** Ver informaci√≥n completa del tour y listado de guests  
**Para:** Realizar checkin efectivo en el punto de encuentro  

**Prioridad:** Alta  
**Estimaci√≥n:** 8 puntos  

### Criterios de Aceptaci√≥n

```gherkin
Feature: Visualizaci√≥n de detalles de tour y guests

Background:
  Given estoy en tour-details.html
  And tengo conexi√≥n a internet

Scenario: Carga exitosa con m√∫ltiples guests
  Given recibo evento con eventId "abc123"
  And description contiene 2 reservas separadas por "----"
  And primera reserva tiene: nombre="Andres Diaz", pax="2 adults", phone="US+1 (813) 541-1433"
  And segunda reserva tiene: nombre="Rene Escobio", pax="2 adults", phone="JP+81 8135075290"
  When parseo la description
  Then muestro header con t√≠tulo "Madrid's Iconic Tapas, Taverns & History Experience"
  And muestro fecha "30/10/2025" y hora "17:30"
  And muestro lista vertical de 2 cards de guests
  And primera card muestra:
    """
    Andres Diaz
    üë• 2 personas
    üìû US+1 (813) 541-1433
    """
  And segunda card muestra:
    """
    Rene Escobio
    üë• 2 personas
    üìû JP+81 8135075290
    """

Scenario: Guest con notas especiales
  Given description contiene reserva con "Special Requirements/Notes: Vegetarian diet"
  When parseo guest
  Then muestro card con:
    """
    [Nombre]
    üë• [Pax] personas
    üìû [Tel√©fono]
    üìù Notas: Vegetarian diet
    """
  And campo notas se muestra con badge/tag visual

Scenario: Falta 1 campo en guest (tel√©fono ausente)
  Given reserva tiene nombre "John Doe" y pax "3 adults"
  And no hay l√≠nea con formato "+X (XXX)" ni c√≥digo de pa√≠s
  When parseo guest
  Then muestro card con:
    """
    John Doe
    üë• 3 personas
    üìû N/A
    """
  And resto de campos se muestran normalmente

Scenario: Falta campo de pax pero resto OK
  Given reserva tiene nombre y tel√©fono pero no l√≠nea "[X] adults"
  When parseo guest
  Then muestro "üë• N/A" en campo personas
  And resto de card renderiza normalmente

Scenario: Faltan m√°s de 2 campos en guest
  Given reserva solo tiene l√≠nea con nombre
  And falta pax y tel√©fono
  When parseo guest
  Then NO renderizo card de este guest
  And incremento contador de guests_con_error
  And al final muestro bot√≥n "Ver evento en Calendar"

Scenario: M√∫ltiples guests con errores de parsing
  Given description tiene 4 reservas
  And 2 reservas tienen datos completos
  And 2 reservas faltan >2 campos
  When parseo todas
  Then muestro solo 2 cards v√°lidas
  And al final de lista muestro:
    """
    ‚ö†Ô∏è 2 reservas con informaci√≥n incompleta
    [Bot√≥n: Ver evento completo en Calendar]
    """

Scenario: Tour sin guests (description vac√≠a)
  Given evento existe pero description=""
  When parseo
  Then muestro header normal
  And muestro mensaje centrado: "Sin informaci√≥n de guests disponible"
  And muestro bot√≥n "Ver evento en Calendar"

Scenario: Formato de tel√©fono internacional variado
  Given guest tiene "US+1 (813) 541-1433"
  When renderizo tel√©fono
  Then muestro "üìû US+1 (813) 541-1433"
  
  Given guest tiene "JP+81 8135075290"
  When renderizo tel√©fono
  Then muestro "üìû JP+81 8135075290"
  
  Given guest tiene "ES+34 612345678 (mobile)"
  When renderizo tel√©fono
  Then muestro "üìû ES+34 612345678"
```

### Reglas de Negocio

**Parsing de description:**
```
Estructura esperada por reserva:
----------------------------------------------------
[ID reserva num√©rico]
[Nombre tour] - [Gu√≠a]
[X adults]                          ‚Üê CAMPO PAX
[Day, DD Month YYYY HH:MM]
[Nombre completo]                   ‚Üê CAMPO NOMBRE
[Email largo]
[PA√çS+C√ìDIGO N√öMERO (tipo)]         ‚Üê CAMPO TEL√âFONO
[Datos financieros...]
Special Requirements/Notes: [texto] ‚Üê CAMPO NOTAS (opcional)
----------------------------------------------------
```

**Criterios de validaci√≥n:**
- **Guest v√°lido:** Tiene nombre + (pax O tel√©fono)
- **Guest incompleto (N/A):** Falta 1 campo ‚Üí mostrar con N/A
- **Guest inv√°lido:** Faltan >2 campos ‚Üí no mostrar, fallback a Calendar

**Prioridad de extracci√≥n:**
1. Separar por l√≠neas `----` (m√≠nimo 4 guiones)
2. Por cada bloque buscar patrones:
   - Pax: l√≠nea contiene " adults"
   - Nombre: primera l√≠nea no-vac√≠a tras l√≠nea de fecha
   - Tel√©fono: l√≠nea con patr√≥n `[A-Z]{2}\+\d+`
   - Notas: l√≠nea empieza con "Special Requirements/Notes:"

### Notas T√©cnicas
- Funci√≥n `parseDescription(text)` retorna `Guest[]`
- Interface Guest: `{ nombre, pax, telefono, notas?, valido: boolean }`
- Regex tel√©fono: `/([A-Z]{2}\+\d+[\s\d\(\)]+)/`
- Regex pax: `/(\d+)\s+adults?/i`

### Definici√≥n de Hecho
- [ ] Header muestra t√≠tulo, fecha y hora correctamente
- [ ] Cards de guests responsive (mobile-first)
- [ ] Parsing extrae correctamente 4 campos (nombre, pax, tel√©fono, notas)
- [ ] Manejo de N/A para campos individuales faltantes
- [ ] Fallback a Calendar si >2 campos faltan por guest
- [ ] Dise√±o visual limpio similar a evento de Calendar
- [ ] Tests unitarios de funci√≥n parseDescription con 5+ casos

---

## USER STORY #3: Manejo de errores API

**ID:** US-TD-003  
**Como:** Gu√≠a  
**Quiero:** Recibir feedback claro cuando falla la carga de datos  
**Para:** Saber c√≥mo proceder o qu√© acci√≥n tomar  

**Prioridad:** Alta  
**Estimaci√≥n:** 3 puntos  

### Criterios de Aceptaci√≥n

```gherkin
Feature: Manejo robusto de errores API

Scenario: Error de red (500/502/503)
  Given llamo a getEventDetails con eventId v√°lido
  And Apps Script retorna status 500
  When capturo el error
  Then muestro mensaje centrado:
    """
    ‚ö†Ô∏è Error al cargar detalles
    No pudimos conectar con el servidor
    """
  And muestro bot√≥n primario "Reintentar"
  And muestro bot√≥n secundario "Ver en Calendar"

Scenario: Timeout de API (>10s)
  Given llamo a getEventDetails
  And la petici√≥n tarda >10 segundos
  When timeout se dispara
  Then muestro mensaje "La conexi√≥n est√° tardando m√°s de lo normal"
  And muestro spinner con texto "Reintentando..."
  And reintento autom√°ticamente 1 vez m√°s
  And si falla segundo intento, muestro botones "Reintentar" y "Ver en Calendar"

Scenario: Evento no encontrado (404)
  Given eventId "xyz999" no existe en Calendar
  When API retorna {error: true, code: 'NOT_FOUND'}
  Then muestro mensaje:
    """
    ‚ùå Tour no encontrado
    El evento no existe o fue eliminado
    """
  And muestro solo bot√≥n "‚Üê Volver al Dashboard"

Scenario: No autorizado (401)
  Given API_KEY es inv√°lida o expir√≥
  When API retorna {error: true, code: 'UNAUTHORIZED'}
  Then muestro mensaje "Sesi√≥n expirada"
  And redirijo a p√°gina de login despu√©s de 3 segundos

Scenario: Description vac√≠a pero evento existe
  Given evento existe con eventId v√°lido
  And description field es ""
  When renderizo p√°gina
  Then muestro header con t√≠tulo y fecha
  And muestro mensaje centrado:
    """
    üìã Sin informaci√≥n de guests
    No hay detalles de reservas disponibles
    """
  And muestro bot√≥n "Ver evento completo en Calendar"

Scenario: Parsing falla para todas las reservas
  Given description tiene texto pero no match con regex
  And ninguna reserva se parsea correctamente
  When intento renderizar guests
  Then muestro mensaje:
    """
    ‚ö†Ô∏è Formato de datos no reconocido
    No pudimos interpretar la informaci√≥n de guests
    """
  And muestro bot√≥n "Ver evento en Calendar"
  And registro error en console para debugging

Scenario: Reintentar tras error
  Given vi error de red
  And hago clic en "Reintentar"
  When se reintenta llamada API
  Then muestro spinner sobre bot√≥n
  And si tiene √©xito, renderizo datos normalmente
  And si falla de nuevo, muestro mismo error

Scenario: Bot√≥n "Ver en Calendar" 
  Given hay error que requiere fallback a Calendar
  When hago clic en "Ver en Calendar"
  Then abro nueva pesta√±a con URL del evento usando htmlLink del evento
  And si no tengo htmlLink, construyo URL: `https://calendar.google.com/calendar/event?eid=[eventId]`
```

### Reglas de Negocio

**Jerarqu√≠a de errores (mostrar en orden de prioridad):**
1. Error de autenticaci√≥n ‚Üí Redirigir a login
2. Evento no encontrado ‚Üí Volver a dashboard
3. Error de red/timeout ‚Üí Reintentar disponible
4. Description vac√≠a ‚Üí Ver en Calendar
5. Parsing fallido ‚Üí Ver en Calendar

**Estrategia de retry:**
- 1 reintento autom√°tico en timeout
- Bot√≥n manual "Reintentar" despu√©s de errores
- No reintentar en 404 o 401

### Notas T√©cnicas
- Timeout fetch: `AbortController` con 10s
- Guardar `htmlLink` del evento en primera carga exitosa
- Log errors a console para debugging (no mostrar stack al usuario)

### Definici√≥n de Hecho
- [ ] Manejo de 5 tipos de error diferentes
- [ ] Mensajes de error claros y accionables
- [ ] Bot√≥n "Reintentar" funcional
- [ ] Fallback a Calendar con URL correcta
- [ ] Tests de cada escenario de error
- [ ] Timeout implementado con AbortController

---

## USER STORY #4: Navegaci√≥n de retorno

**ID:** US-TD-004  
**Como:** Gu√≠a  
**Quiero:** Volver f√°cilmente al dashboard  
**Para:** Continuar mi flujo de trabajo sin fricci√≥n  

**Prioridad:** Media  
**Estimaci√≥n:** 2 puntos  

### Criterios de Aceptaci√≥n

```gherkin
Feature: Navegaci√≥n de retorno al dashboard

Scenario: Bot√≥n back en header
  Given estoy en tour-details.html
  And veo bot√≥n "‚Üê Volver" en header
  When hago clic en el bot√≥n
  Then navego a "/guide.html"
  And dashboard carga secci√≥n "Mis Pr√≥ximas Asignaciones"

Scenario: Navegaci√≥n con bot√≥n back del navegador
  Given navegu√© desde guide.html a tour-details.html
  When presiono bot√≥n back del navegador/PWA
  Then vuelvo a guide.html
  And estado del dashboard se preserva (no recarga)

Scenario: Navegaci√≥n en PWA iOS
  Given app instalada en iOS
  When hago clic en "‚Üê Volver"
  Then navego sin animaci√≥n de navegador externo
  And uso transici√≥n nativa de PWA

Scenario: Bot√≥n volver tras error 404
  Given evento no encontrado
  And veo mensaje "Tour no encontrado"
  When hago clic en "Volver al Dashboard"
  Then navego a "/guide.html"
```

### Notas T√©cnicas
- Usar `window.location.href = '/guide.html'` en lugar de `history.back()` para evitar loops
- Header fijo con z-index alto
- Icono back: `‚Üê` o SVG de flecha

### Definici√≥n de Hecho
- [ ] Bot√≥n "‚Üê Volver" visible en header
- [ ] Click navega a guide.html
- [ ] Funciona en PWA y navegador
- [ ] Bot√≥n responsive mobile/desktop

---

## Resumen de Implementaci√≥n

### Prioridad de desarrollo
1. **US-TD-002** (Core): Visualizaci√≥n y parsing ‚Üê CR√çTICO
2. **US-TD-001**: Navegaci√≥n desde dashboard
3. **US-TD-003**: Manejo de errores
4. **US-TD-004**: Navegaci√≥n de retorno

### Archivos involucrados
- `public/tour-details.html` (nuevo)
- `public/js/tour-details.js` (nuevo)
- `public/js/calendar-api.js` (modificar: a√±adir `getTourGuestDetails()`)
- `public/js/guide-dashboard.js` (modificar: hacer cards clicables)
- Apps Script: a√±adir endpoint `getEventDetails`

### M√©tricas de √©xito
- Tasa de parsing exitoso: >95%
- Tiempo de carga: <2s en 4G
- Error rate: <2% en producci√≥n
- Usuarios usando fallback "Ver en Calendar": <5%

---

**Aprobado por:** [Pendiente]  
**Fecha aprobaci√≥n:** [Pendiente]
